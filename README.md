# TechCare Support in Salesforce
## Informa√ß√µes do Respons√°vel
- Nome: Anderson Carvalho
- Perfil Escolhido: **Desenvolvedor** com conhecimentos em Admin

## TechCare Support Project
TechCare support √© uma solu√ß√£o para cria√ß√£o e administra√ß√£o de casos de suporte. A partir do app TechCare Support o usu√°rio do suporte pode registrar casos, pegar casos da fila baseado na prioridade, verificar dashboards essenciais na Home do App, verificar SLA de forma r√°pida, visual e intuitiva dentre outras vantagens. O foco do TechCare Support √© aumentar a produtividade e organiza√ß√£o da equipe de suporte.

## üîß Tecnologias Utilizadas

- Salesforce (SFDX)
- Apex
- Triggers
- LWC (Lightning Web Components)
- Flows
- Permission Sets
- Validation Rules
- Git + GitHub

## üìÅ Estrutura do Projeto

```bash
.
‚îú‚îÄ‚îÄ force-app/                  # Elementos principais da org
‚îÇ   ‚îî‚îÄ‚îÄ main/default/
‚îÇ       ‚îú‚îÄ‚îÄ classes/            # Apex classes e testes
‚îÇ       ‚îú‚îÄ‚îÄ triggers/           # Triggers Apex
‚îÇ       ‚îú‚îÄ‚îÄ lwc/                # Componentes Lightning Web Components
‚îÇ       ‚îú‚îÄ‚îÄ objects/            # Objetos customizados
‚îÇ       ‚îú‚îÄ‚îÄ permissionsets/     # Permiss√µes customizadas
‚îÇ       ‚îî‚îÄ‚îÄ messageChannels/    # Canais de mensagem (pubSub do LWC)
```

## üõ†Ô∏è Funcionalidades Implementadas

### üîê Profiles e Permission sets
Para gerenciar melhor os acessos e permiss√µes da solu√ß√£o foi criado um profile chamado **Support** com permiss√µes b√°sicas essenciais para usu√°rio do suporte. 

Para permiss√µes mais espec√≠ficas foram criados dois permission sets, o **Support Premium** e o **Support Standard.** Assim, facilitando a atribui√ß√£o de permiss√µes espec√≠ficas para cada usu√°rio espec√≠fico. 

Foi utilizado esse modelo de permissionamento seguindo as **boas pr√°ticas** do Salesforce na utiliza√ß√£o de Permission Sets. Assim, seguindo a l√≥gica de perfis para permiss√µes gerais e Permission Sets para permiss√µes espec√≠ficas.

---  

### üß± Custom Objects
#### Case_Request__c 
Para registrar os casos de suporte foi criado um objeto Case Request. O objeto Case Request armazena informa√ß√µes importantes para casos, nele, atrav√©s de campos, √© poss√≠vel armazenar o assunto, descri√ß√£o, status, prioridade e dentre outras informa√ß√µes importantes para a regra de neg√≥cio. 
#### üìò Estrutura do Case_Request__c
| Label             | API Name              | Type                   | Required | Observa√ß√µes               |
|-------------------|-----------------------|------------------------|----------|--------------------------|
| Case Request Number | Name                  | Auto Number            | Sim      | Campo identificador √∫nico |
| Created By         | CreatedById           | Lookup(User)           | N√£o      | Usu√°rio que criou o registro |
| Description        | Description__c        | Long Text Area (32.768) | N√£o      | Descri√ß√£o detalhada do caso |
| Last Modified By   | LastModifiedById      | Lookup(User)           | N√£o      | Usu√°rio que modificou por √∫ltimo |
| Owner              | OwnerId               | Lookup(User, Group)    | Sim      | Dono atual do registro (usu√°rio ou grupo) |
| Priority           | Priority__c           | Picklist               | N√£o      | N√≠vel de prioridade do caso |
| Record Type        | RecordTypeId          | Record Type            | Sim      | Tipo de registro configurado |
| Resolution Notes   | Resolution_Notes__c   | Long Text Area (32.768) | N√£o      | Notas sobre a resolu√ß√£o do caso |
| SLA Deadline       | SLA_Deadline__c       | Date/Time              | N√£o      | Data/hora limite para SLA |
| Status             | Status__c             | Picklist               | Sim      | Status atual do caso      |
| Subject            | Subject__c            | Text (255)             | N√£o      | Assunto do caso          |
#### Case_History__c
Para registrar o hist√≥rico do registro foi criado um objeto Case History. O objeto Case History √© criado e armazena valores que s√£o populados ap√≥s o fechamento do Case. 
#### üìò Estrutura do Objeto: Case_History

| Label             | API Name              | Type                        | Required | Observa√ß√µes                            |
|-------------------|------------------------|-----------------------------|----------|----------------------------------------|
| Name              | Name                   | Text (80)                   | Sim      | Nome identificador do hist√≥rico        |
| Case Request      | Case_Request__c        | Master-Detail (Case Request) | Sim      | Relacionamento obrigat√≥rio com o caso  |
| Created By        | CreatedById            | Lookup (User)               | N√£o      | Usu√°rio que criou o registro           |
| Last Modified By  | LastModifiedById       | Lookup (User)               | N√£o      | √öltimo usu√°rio que modificou o registro|
| SLA Met           | SLA_Met__c             | Checkbox                    | N√£o      | Indica se o SLA foi atendido ou n√£o    |
| Time Closed       | Time_Closed__c         | Date/Time                   | N√£o      | Momento em que o caso foi encerrado    |

### üßæ RecordTypes do Case_Request__c
Para diferenciar as regras de neg√≥cios de cada Permission Set, fez-se necess√°rio criar dois RecordTypes, fazendo com que o objeto Case_Request__c tenha regras diferentes para cada tipo de objeto. 

Com a cria√ß√£o do record type √© poss√≠vel fazer a regra de neg√≥cio atrav√©s de Page layouts, Permission sets, Lightning pages e etc... Garantindo maior organiza√ß√£o e consist√™ncia em toda regra de neg√≥cio. 
- Support Premium (Support_Premium)
- Support Standard (Support_Standard)

---  

### üèóÔ∏è App Lightning TechCare Support
Para facilitar a gest√£o e organiza√ß√£o da solu√ß√£o existe o App Lightning TechCare Support.
O App √© vis√≠vel apenas para usu√°rios com o perfil Support criado para este fim, e tamb√©m √© vis√≠vel para o Admin da ORG.

#### üé® Branding e Identidade
- üñºÔ∏è **√çcone customizado** e nome amig√°vel "TechCare Support" para facilitar a identifica√ß√£o do app.
- üéØ O foco principal √© a experi√™ncia do usu√°rio de suporte, com navega√ß√£o simplificada e componentes Lightning Web Components (LWC) aplicados na p√°gina do registro.

#### Tabs
- Home
- Case Request
- Dashboards
- Reports

---  

### üìä Relat√≥rios e Dashboard de Casos

#### a. üîç Relat√≥rio Tabular - Casos Abertos por Prioridade e Status
- **Nome:** Open Cases
- **Tipo:** Matriz tabular
- **Campos:**
  - **Prioridade:** High, Medium, Low, (sem valor)
  - **Status:** New, In Progress, Escalated, Closed
- **Totaliza√ß√£o:** Soma por status e prioridade
- **Objetivo:** Visualizar rapidamente a quantidade de casos abertos por por prioridade e status.


#### 2. Dashboard: An√°lise de Casos

#### 1. Open Cases - Last 7 Days
- **Tipo:** Donut Chart
- **M√©trica:** Contagem de casos
- **Segmenta√ß√£o:**
  - **Opened:** Casos com `Status__c` = *New*, *In Progress*, *Escalated*
  - **Closed:** Casos com `Status__c` = *Closed*
- **Filtro:** Casos criados nos √∫ltimos 7 dias
- **Objetivo:** Comparar visualmente a propor√ß√£o de casos ainda em aberto versus casos encerrados recentemente.

#### 2. Average Resolution Time by Type
- **Tipo:** Gr√°fico de barras verticais
- **M√©trica:** Tempo m√©dio de resolu√ß√£o (em dias)
- **Fonte:** Campo `Time_Closed__c` do objeto **Case_History__c**
- **C√°lculo:** M√©dia do tempo de resolu√ß√£o, agrupada por **Record Type** do objeto **Case_Request__c**
- **Objetivo:** Avaliar a efici√™ncia de resolu√ß√£o conforme o tipo de suporte.

---  

### ‚ö° Page Layouts e Lightning Record Pages
- Foram criados Page Layouts e Lightning Record Pages espec√≠ficas para cada record type.
- Na Page Layout e Lightning Record Page do Standard Premium foi configurado o campo Priority como obrig√°torio.
- O campo SLA Deadline n√£o deve aparecer para o Support Standard. Para isso foi garantido que Na Page Layout e na Lightning Record Page n√£o apareca.
- No Lightning Record Page do Support Premium o campo SLA_Deadline__c s√≥ √© exibido se o priority for diferente de 'Low'
- Para cada Record Type foi criado um layout e posicionamento diferente.

---  

### ‚öôÔ∏è Valida√ß√µes e Automa√ß√µes  
#### ‚è∞ Set SLA Deadline By RecordType (Record Triggered Flow)  
Atribui o valor do SLA_Deadline__c baseado no RecordType do objeto.   

Caso o registro seja do tipo Support Premium o flow define o SLA_Deadline__c como DateTime atual + 24h. Support Standard define o SLA_Deadline__c como DateTime atual + 8h.  

Foram criadas 2 condi√ß√µes pois, apenas um if-else ap√≥s a adi√ß√£o futura de outro RecordType no Case_Request__c o flow iria quebrar, pois, o else iria para qualquer RecordType. Portanto, foram criados tr√™s caminhos, Support Premium, Standard e Default Outcome (Vazio).  

![image](https://github.com/user-attachments/assets/5acc893a-75b5-4d91-b8dd-69e9db5451c7)  

#### üì• Assignment Case to Queue (Auto Launched Flow)  
Com uma l√≥gica semelhante ao flow Set SLA Deadline By RecordType, esse flow pega o recordId do Case_Request__c e define o Owner desse case a uma fila.  

Foram criadas duas filas, a fila Support Premium Queue e Support Standard Queue. Com isso, baseado no RecordType o flow atribui o OwnerId a uma das respectivas filas.  

Al√©m disso ao final desse flow √© enviado um email para os usu√°rios da fila informando que o case foi atribuido a fila.

---  

#### Create Case Request (Record triggered Flow)

Ao criar o Case request esse flow √© acionado e chama o Assignment Case to Queue atrav√©s de um subflow.

Esse flow foi criado para que o flow autolaunched funcione atrav√©s de um bot√£o e atrav√©s de um record triggered flow como este tamb√©m.

---

#### Flow Send Email
Flow respons√°vel por enviar email para membros de uma fila espec√≠fica, informando que um novo caso foi atribu√≠do a fila.

Verifica se existe membro na fila, caso tenha membro na fila ele pega os membros e envia o email.

Este flow √© chamado ao final do flow Assign to Queue.

#### üö´ Require ResolutionNotes Before Close (Validation Rule)  
Impede que o Case Request seja fechado sem antes ter preenchido o campo Resolution_Notes__c do objeto.  

```bash
AND (
  ISPICKVAL( Status__c , 'Closed'),
  ISBLANK( Resolution_Notes__c )
)
```

---

#### üîê Case Reopen Permission Validation (Validation Rule)
Verifica se o usu√°rio tem permiss√£o para reabrir um caso.
```bash
AND(
  ISCHANGED( Status__c ),
  NOT(ISPICKVAL( Status__c , 'Closed')),
  NOT($Permission.canReopenCaseRequest)
)
```

---

### üé® Lightning Web Components ( LWC )
- ü™ü `caseCloseModal`: Componente de modal customizado para encerramento de casos com regras de valida√ß√£o.
Modal com um campo para inserir o resolution notes e encerrar o caso.
Este componente √© filho do caseRequestDetail, onde possu√≠ comunica√ß√£o enviando informa√ß√µes para o pai, e recebendo informacoes do pai
- üßæ `caseRequestDetail`: SLA_Deadline__c em contagem regressiva din√¢mica e bot√µes para reabrir, avan√ßar para In Progress e fechar caso. 
![image](https://github.com/user-attachments/assets/432ef146-dc37-4e4d-b2cc-b368531ccbe2)
- `caseResolutionNotes`: Componente que funciona a partir de uma comunica√ß√£o PubSub. ele √© o subscriber e o componente caseRequestDetail √© o publisher. Quando o Case √© fechado no LWC, o publisher envia o pub e ap√≥s isso o caseResolutionNotes se insreveve e exibe as informa√ß√µes.

---

### üß† Apex classes  
#### üì¶ Classe `CaseRequestDetailController.cls` 
Esta √© a classe que interage com as requisi√ß√µes do componente `caseRequestDetail`, enviando dados espec√≠ficos a partir de chamadas no LWC.

#### üß© Arquitetura - CaseRequestDetailController
```bash
üß± CaseRequestDetailController           # Classe que faz o contado direto com o FRONT, recebe as requisi√ß√µes do front e chama o service para realizar a regra.
‚îÇ
‚îî‚îÄ‚îÄ üß† CaseRequestDetailService          # Classe que √© chamada pelo Controller e faz toda a l√≥gica da regra solicitada pelo LWC.
```
Foi utilizado essa arquitetura a fim de garantir mais Escalabilidade, Manutenibilidade, Reaproveitamento de c√≥digo e boas pr√°ticas devido a separa√ß√£o de responsabilidades. 

##### üß© M√©todo `getSLAInfo(Id caseRequestId)`  
- üß© **Fun√ß√£o**: Consulta os dados de Case_Request__c pelo Id retorna campos ess√™nciais para criar a regra do timer regressivo do SLA.  
- üîÅ **Chamado por**: Pelo @wire do LWC caseRequestDetail passando o recordId como par√¢metro`.  

##### üß© M√©todo `reopenCaseRequest(Id caseRequestId)`  
- üß© **Fun√ß√£o**: Reabre o Case Request alterando o Status__c para In progress.  
- üîÅ **Chamado por**: Pelo @wire do LWC caseRequestDetail passando o recordId como par√¢metro`.  
- ‚úÖ **Valida√ß√µes**:  
  - üõ°Ô∏è Verifica se o usu√°rio tem o Permission Set Support_Premium. Apenas usu√°rios com o Permission Set Support Premium podem reabrir casos.  

##### üß© M√©todo `SupportPremiumUser(String permissionSetName)`  
- üß© **Fun√ß√£o**: Consulta se o usu√°rio atual possui a Permission set atribu√≠da atrav√©s de uma query no PermissionSetAssignment, passando o Id do user e a Permission Set no WHERE.  
- üîÅ **Chamado por**: Pela pr√≥pria classe atrav√©s dos m√©todos getSLAInfo(Id caseRequestId) e reopenCaseRequest(Id caseRequestId) `.  

---
### üß† Apex REST Resource Class 
#### üåê Classe `CaseRequestRestResource.cls`  
Classe respons√°vel por expor um endpoint REST que retorna informa√ß√µes sobre um Case Request espec√≠fico, dado o seu `Id`.  

##### üß© M√©todo `getCaseRequestInfo()`  
- üß© **Fun√ß√£o**: Exp√µe um endpoint `GET` no caminho `/services/apexrest/CaseRequest/{id}` que retorna o `Status` e o `SLA_Met` do registro de `Case_Request__c`.  
- üîÅ **Chamado por**: Requisi√ß√µes externas via REST API (ex.: Postman, sistemas externos, integra√ß√µes).  
- ‚úÖ **Valida√ß√µes e comportamentos**:  
  - ‚ùì Verifica se o `caseId` est√° presente e √© v√°lido (15 caracteres ou mais).  
  - üîé Consulta o `Status__c` e o √∫ltimo `Case_History__c` relacionado, retornando seu campo `SLA_Met__c`.  

#### Endpoint
`GET /services/apexrest/CaseRequest/{caseId}`

#### Par√¢metros
| Par√¢metro | Tipo   | Obrigat√≥rio | Descri√ß√£o                      |
|-----------|--------|-------------|-------------------------------|
| caseId    | string | Sim         | ID do Case_Request__c         |

#### Sucesso (200)
```json
{
  "Status": "Em An√°lise",
  "Sla_Met": true
}
```
- Exemplo Body
```bash
{
  "Status": string,
  "Sla_Met": boolean
}
```
#### Erro (400)
```json
{
  "error": "Invalid or missing CaseRequest Id"
}
```
#### Erro (404)
```json
{
  "error": "Case request not found"
}
```

### ‚ö° Apex triggers 
#### üìù CaseRequestTrigger 
Cria um registro de Case History vinculado ao Case Request. 
- üß© **Fun√ß√£o**: Sempre que o Objeto alterar o Status para Closed a trigger ir√° criar um registro de Case History, ir√° popular o `Time_Closed__c` com a DateTime Now e ir√° verificar se o SLA foi cumprido. Caso o SLA seja cumprido o campo `SLA_Met__c` ser√° true, ao contrario ser√° false.`.  
- üîÅ **Acionado**: O Trigger √© acionado sempre que um objeto √© alterado, o Helper verifica se o objeto teve o Campo `Status__c` mudado para 'Closed'.  

#### üß© Arquitetura de Trigger - Case Request
```bash
üìå CaseRequestTrigger                 # Trigger Verificando AFTER_UPDATE e chamando `CaseRequestHandler.afterUpdate(oldCases, newCases)`
‚îÇ
‚îî‚îÄ‚îÄ üß± CaseRequestHandler             # Handler pegando os registros alterados, verificando se o status foi fechado, mandando para o Service criar o Case_History__c e inserindo no BD
‚îÇ
‚îî‚îÄ‚îÄ üß† CaseRequestService             # Service que verifica se o `SLA_Deadline` foi cumprido e cria o objeto `Case_History__c` populando os campos de forma din√¢mica
```

## üöÄ Instru√ß√µes de Instala√ß√£o e Deploy

### üì¶ Pr√©-requisitos

- Salesforce CLI (SFDX)
- VS Code com Salesforce Extension Pack
- Conta DevHub, Scratch Org ou Sandbox
- Git instalado
- Acesso ao reposit√≥rio do projeto

---

### üîÅ 1. Clone o Reposit√≥rio

```bash
git clone https://github.com/seu-usuario/seu-repositorio.git
cd seu-repositorio
```
### üîê 2. Login na Org Salesforce
#### DevHub:
```bash
  sfdx auth:web:login --setalias DevHub --setdefaultdevhubusername
```
### üì§ 3. Deploy do Projeto
```bash
sfdx force:source:deploy -p force-app/main/default -u TechCareSandbox
```
### üåê 4. Abrir a Org e App Lightning
```bash
sfdx force:org:open
```
### ‚úÖ 5. Rodar Testes Apex
```bash
sfdx force:apex:test:run --resultformat human --outputdir test-results --wait 10
```
### ‚öôÔ∏è 6. P√≥s-Deploy Manual
- Criar filas: Support Premium Queue e Support Standard Queue
- Configurar Record Types com layouts e lightning pages
- Atribuir usu√°rios ao perfil Support
- Atribuir Permission Set Support_Standard ou Support_Premium

## üîç Como Testar Manualmente a Aplica√ß√£o

1. **Abra o App TechCare Support**
   - No App Launcher, selecione **TechCare Support**.
   - Verifique se os **dashboards** s√£o exibidos corretamente na Home.

2. **Criar um novo Case Request**
   - V√° para a aba **Case Request**.
   - Clique em **Novo** (Record type ser√° definido automaticamente de acordo com o user Premium ou Standard)
   - Preencha os campos obrigat√≥rios
   - Salve o registro.

3. **Verificar c√°lculo do SLA Deadline**
   - Ap√≥s salvar, abra o Case Request.
   - Verifique o campo **SLA Deadline**:
     - Deve ser preenchido automaticamente com +24h (Premium) ou +8h (Standard).
     - No perfil Standard SLA Deadline n√£o aparece 
   - No LWC, o contador regressivo deve aparecer **somente para Premium**.

4. **Testar bot√£o de atribui√ß√£o √† fila**
   - Clique no bot√£o de **assign to queue** no LWC.
   - Confirme se o **OwnerId** do registro foi alterado para a fila correta (Premium ou Standard Queue).

5. **Fechar o caso**
   - No Lwc, Clique em **Marcar como Completed**.
   - O modal deve aparecer com campo de resolu√ß√£o.
   - Tente fechar sem preencher o campo **Resolution Notes** ‚Üí deve exibir erro
   - No support Standard, apos fechar o caso tente abrir novamente. Deve exibir um erro de validation rule 
     

6. **Reabrir caso**
   - Ap√≥s fechar um caso, no LWC clique em **Reabrir caso**.
   - Apenas usu√°rios com permission set **Support_Premium** devem conseguir reabrir.
   - O status do caso deve voltar para **In Progress**.

7. **Verificar cria√ß√£o do hist√≥rico**
   - Ap√≥s fechar um caso, acesse os **registros relacionados**.
   - Um novo **Case_History__c** deve ter sido criado.
   - Verifique se os campos **Time Closed** e **SLA Met** est√£o corretos.

---





